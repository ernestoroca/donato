<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3.css">
    <script>
window.speechSynthesis.cancel();
var speech = new SpeechSynthesisUtterance();
speech.lang = "en";
var ingles = null;
window.speechSynthesis.onvoiceschanged = function(){
    if(ingles !== null){
        return;
    }
    let voices = window.speechSynthesis.getVoices();
    let len = voices.length;
    ingles = [];
    for(let i=0;i<len;i++){
        if(voices[i].lang === "en-US"){
            ingles.push(voices[i]);
        }
    }
};

var basedatos = null;

function cargarArchivo(cb){
    var script = document.createElement('script');
    script.onload = cb;
    script.src = "https://ernestoroca.github.io/donato/"+respuestas.leccion+".js";
    document.head.appendChild(script);
}
      
function selectLeccion(){
    basedatos.leccion = document.getElementById("selector-leccion").value;
    basedatos.unidad = "unidad1";
    document.getElementById("selector-unidad").value = basedatos.unidad;
    cargarArchivo(cargarUnidad);
}  

function selectUnidad(){
    basedatos.unidad = document.getElementById("selector-unidad").value;
    cargarUnidad();
}
  
function cargarUnidad(){
    switch(basedatos.unidad){
      case "unidad1":
          basedatos.preguntas = unidad1;
          break;
      case "unidad1":
          basedatos.preguntas = unidad2;
          break;
    }
    
    let len = basedatos.preguntas.length;
    let vec = [];
    for(let i=0;i<len;i++){
        vec.push(10);
    }
    basedatos.max = len*10;
    basedatos.valores = vec;
    preguntar();
}
      
function alcargar(){
    let str = localStorage.getItem("ingles");
    if(str){
        basedatos = JSON.parse(str);
    } else {
        basedatos = {
            leccion: "leccion1",
            unidad: "unidad1"
        };
    }
    document.getElementById("selector-leccion").value = basedatos.leccion;
    document.getElementById("selector-unidad").value = basedatos.unidad;
    cargarArchivo(cargarUnidad);
}
      
function preguntar(){
    let len = basedatos.preguntas.length;
    let pos = 0;
    let salto;
    let max = (basedatos.max>40)?40:basedatos.max;
    salto = Math.floor(max*Math.random())+1;
    while(salto>basedatos.valores[pos]){
        salto -= basedatos.valores[pos];
        pos++;
    }
    basedatos.actual = pos;
    mostrarPregunta();
}

function mostrarPregunta(){
    let str = basedatos.preguntas[basedatos.actual];
    let vec = str.split("|");
    let len = vec.length;
    let strHtml = "";
    for(let i=0;i<len;i++){
        strHtml += `
<div class="w3-row">
  <div class="w3-col s10">
    <input id="texto-${i}" class="w3-input" type="text">
  </div>
  <div class="w3-col s2">
    <button id="play-${i}" class="w3-button w3-green w3-border w3-border-black w3-round-large">Play</button>
  </div>
</div>
        `;
    }
    document.getElementById("pizarra").innerHTML = strHtml;
    document.getElementById("alerta").innerHTML = "";
}

function evaluar(){
    if(basedatos.respuestas.actual === -1){
        preguntar();
        return;
    }
    let str = basedatos.preguntas[basedatos.actual];
    let vec = str.split("|");
    let len = vec.length;
    let res = "";
    
    let fallo = false;
    for(let i=0;i<len;i++){
        let texto = document.getElementById("texto-"+i).value;
        texto = texto.trim();
        texto = texto.toLowerCase();
        if(vec[i] !== texto){
            fallo = true;
        }
        document.getElementById("texto-"+i).value = vec[i];
    }
    
    if(fallo){
        let valorActual = basedatos.valores[basedatos.actual];
        let delta = 10 - valorActual;
        basedatos.max += delta;
        basedatos.valores[basedatos.actual] = 10;
        document.getElementById("alerta").innerHTML = `
<div class="w3-panel w3-red">
  <h3>Error</h3>
  <p>Sigue intentando.</p>
</div> `;
    } else {
        basedatos.max--;
        basedatos.valores[basedatos.actual]--;
        document.getElementById("alerta").innerHTML = `
<div class="w3-panel w3-green">
  <h3>¡Exito!</h3>
  <p>Así se hace.</p>
</div> `;
    }
    basedatos.actual = -1;
    localStorage.setItem("ingles",JSON.stringify({
        leccion: basedatos.leccion,
        unidad: basedatos.unidad,
        max: basedatos.max,
        valores: basedatos.valores
    }));
}

function clickPizarra(evento){
    let target = evento.target;
    if (target.id === ""){
        target = target.parentNode;
    }
    if(target.id === "pizarra"){
        return;
    }
    if(!target.id.includes("play-")){
        return;
    }
    let elId = target.id.replace("play-","");
    let num = parseInt(elId,10);
    
    let str = basedatos.preguntas[basedatos.actual];
    let vec = str.split("|");
    
    window.speechSynthesis.cancel();
    speech.voice = ingles[Math.floor(Math.random()*ingles.length)];
    speech.text = vec[num];
    window.speechSynthesis.speak(speech);
}
    </script>    
  </head>
  <!-- ################################################################################## -->
  <!-- ################################################################################## -->
  <body onload="alcargar();">
    <div class="w3-row">
      <div class="w3-col s12 m6 l4">
        <select class="w3-select" id="selector-leccion">
          <option value="" selected>...</option>
          <option value="leccion1">Lección 1</option>
          <option value="leccion2">Lección 2</option>
          <option value="leccion3">Lección 3</option>
        </select>
      </div>
      <div class="w3-col s12 m6 l4">
        <select class="w3-select" id="selector-unidad">
          <option value="" selected>...</option>
          <option value="unidad1">Unidad 1</option>
          <option value="unidad2">Unidad 2</option>
          <option value="unidad3">Unidad 3</option>
          <option value="unidad4">Unidad 4</option>
          <option value="unidad5">Unidad 5</option>
          <option value="unidad6">Unidad 6</option>
          <option value="unidad7">Unidad 7</option>
          <option value="unidad8">Unidad 8</option>
          <option value="unidad9">Unidad 9</option>
        </select>
      </div>
    </div>
    <div id="pizarra"></div>
    <div class="w3-row">
      <div class="w3-col s12">
        <button onclick="evaluar();" class="w3-button w3-green w3-border w3-border-black w3-round-large">Evaluar</button>
      </div>
    </div>
    <div id="alerta"></div>
    <script>
document.getElementById("pizarra").onclick = clickPizarra;
document.getElementById("selector-leccion").onchange = selectLeccion;
document.getElementById("selector-unidad").onchange = selectUnidad;
    </script>  
  </body>
</html>
    
        
